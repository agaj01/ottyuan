name: Sync ott files

on:
  schedule:
    - cron: '0 2 * * *'    # 每日 02:00 UTC，按需修改
  workflow_dispatch:

# 确保 workflow 有写仓库内容的权限
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # 允许后续 git push 使用 GITHUB_TOKEN
          fetch-depth: 0

      - name: Ensure directory exists
        run: mkdir -p telecom mobile

      - name: Download external ott files
        run: |
          set -euo pipefail

          # Helper to download a file but skip on failure
          download() {
            local url="$1"
            local out="$2"
            local label="$3"
            echo "Downloading ${label} from ${url} ..."
            # add --retry and --retry-delay to improve robustness
            if curl -fsSL --retry 2 --retry-delay 2 -o "${out}" "${url}"; then
              echo "Downloaded ${label} -> ${out}"
            else
              echo "Failed to download ${label} from ${url} — skipping"
            fi
          }

          download "https://raw.githubusercontent.com/wind005/TVlive/main/m3u/henyd.m3u" "mobile/wind005.m3u" "henyd.m3u"
          download "https://raw.githubusercontent.com/wind005/TVlive/main/m3u/hendx.m3u" "telecom/wind005.m3u" "hendx.m3u"
          download "https://raw.githubusercontent.com/lizanyang3/lizanyang3.github.io/main/hn.m3u" "mobile/lizanyang3.m3u" "hn.m3u"
          download "https://raw.githubusercontent.com/xisohi/CHINA-IPTV/main/Unicast/henan/mobile.txt" "mobile/xisohi.txt" "mobile.txt"

          git status --porcelain || true

      - name: Commit and push if changed
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: sync ott files from external repos"
            git push
          else
            echo "No changes to commit."
          fi
